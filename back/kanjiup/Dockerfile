FROM node:buster-slim as builder
WORKDIR /api

COPY package*.json ./

RUN npm install

COPY . .

RUN npm run build

FROM node:buster-slim

ENV AWS_ACCESS_ID=${AWS_ACCESS_ID}
ENV AWS_ACCESS_SECRET=${AWS_ACCESS_SECRET}
ENV AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
ENV CF_ACC_ID=${CF_ACC_ID}
ENV MONGO_URI=${MONGO_URI}
ENV MONGO_DB_NAME=${MONGO_DB_NAME}
ENV MONGO_COLLECTION=${MONGO_COLLECTION}
ENV KANJI_RECOGNIZER_KEY=${KANJI_RECOGNIZER_KEY}
ENV AUTH_API_SECRET_KEY=${AUTH_API_SECRET_KEY}
ENV AUTH_API_SECRET_WEB=${AUTH_API_SECRET_WEB}
ENV AUTH_API_SECRET_NATIVE=${AUTH_API_SECRET_NATIVE}
ENV PORT=${PORT}

WORKDIR /api

COPY package*.json ./

RUN npm install --only=prod

COPY . .

COPY --from=builder /api/dist ./dist

EXPOSE ${PORT}

CMD node dist/app.js
